- job: unit_test
  displayName: "Unit Test"
  pool:
    name: "Doitsu Technology Linux Pipeplies"
    vmImage: "Doitsu.Technology.Ubuntu.Agent"
  variables:
    buildConfiguration: "Release"
    secretBuilderEmail: "$(SECRET_BUILDER_EMAIL)"
    secretBuilderPat: "$(SECRET_BUILDER_PAT)"
    ConnectionStrings.EcommerceDbContext: "$(SECRET_CONNECTION_STRING)"
    DeliveryIntegration.Ghtk.ClientSecret: "$(SECRET_GHTK_TOKEN)"
    SmtpMailServerOptions.CredentialPassword: "$(SECRET_SMTP_CREDENTIAL_PASSWORD)"
  steps:
    - task: replacetokens@3
      inputs:
        rootDirectory: "./"
        targetFiles: "**/*.config"
        encoding: "auto"
        writeBOM: true
        actionOnMissing: "warn"
        keepToken: false
        tokenPrefix: "#{"
        tokenSuffix: "}#"
        useLegacyPattern: false
        enableTelemetry: true
    - task: FileTransform@1
      displayName: "File Transform: appsettings.json"
      inputs:
        folderPath: "$(System.DefaultWorkingDirectory)"
        fileType: json
        targetFiles: "**/appsettings.json"
    - task: DotNetCoreCLI@2
      displayName: "Test Process"
      inputs:
        command: test
        projects: "**/*Tests/*.csproj"
        arguments: "--configuration $(buildConfiguration)"
